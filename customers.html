<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>DeltaV â€” ğŸ‘¥ Customers</title><link rel="stylesheet" href="theme.css"><style></style></head><body><script>if(sessionStorage.getItem("dv_admin")!=="1"){location.href="login.html";}</script><div class="sidebar"><div class="sb-logo">DeltaV <span>Auto</span><small>Admin Panel</small></div><nav><div class="sb-sec">Core</div><a href="dashboard.html" class=""><span class="ni">ğŸ“Š</span>Dashboard</a><a href="admin.html" class=""><span class="ni">ğŸ“…</span>Bookings</a><a href="schedule.html" class=""><span class="ni">ğŸ—“ï¸</span>Schedule</a><a href="customers.html" class="active"><span class="ni">ğŸ‘¥</span>Customers</a><a href="invoices.html" class=""><span class="ni">ğŸ’°</span>Invoices</a><div class="sb-sec">Stock & Money</div><a href="inventory.html" class=""><span class="ni">ğŸ“¦</span>Inventory</a><a href="payments.html" class=""><span class="ni">ğŸ’³</span>Payments</a><a href="finance.html" class=""><span class="ni">ğŸ“ˆ</span>Finance</a><a href="workers.html" class=""><span class="ni">ğŸ‘·</span>Workers</a><div class="sb-sec">Operations</div><a href="jobs.html" class=""><span class="ni">ğŸ”©</span>Job Cards</a><a href="quotes.html" class=""><span class="ni">ğŸ“‹</span>Quotes</a><a href="suppliers.html" class=""><span class="ni">ğŸ­</span>Suppliers</a><a href="expenses.html" class=""><span class="ni">ğŸ§¾</span>Expenses</a><a href="reports.html" class=""><span class="ni">ğŸ“‰</span>Reports</a><div class="sb-sec">Communication</div><a href="messages.html" class=""><span class="ni">ğŸ’¬</span>Messages</a><a href="notes.html" class=""><span class="ni">ğŸ“</span>Notes</a><a href="reminders.html" class=""><span class="ni">ğŸ””</span>Reminders</a><a href="vehicles.html" class=""><span class="ni">ğŸš—</span>Vehicle DB</a><div class="sb-sec">Extra</div><a href="audit.html" class=""><span class="ni">ğŸ”</span>Audit Log</a><a href="tasks.html" class=""><span class="ni">âœ…</span>Tasks</a><a href="timesheets.html" class=""><span class="ni">â±ï¸</span>Timesheets</a><a href="warranties.html" class=""><span class="ni">ğŸ›¡ï¸</span>Warranties</a><a href="promotions.html" class=""><span class="ni">ğŸ</span>Promotions</a><a href="feedback.html" class=""><span class="ni">â­</span>Feedback</a><a href="returns.html" class=""><span class="ni">â†©ï¸</span>Returns</a><a href="waiting.html" class=""><span class="ni">â³</span>Waiting List</a><a href="checklist.html" class=""><span class="ni">â˜‘ï¸</span>Checklists</a><a href="gallery-admin.html" class=""><span class="ni">ğŸ“¸</span>Gallery Mgr</a><a href="targets.html" class=""><span class="ni">ğŸ¯</span>Targets</a><a href="settings.html" class=""><span class="ni">âš™ï¸</span>Settings</a></nav><div class="sb-foot"><a href="index.html" class="btn-sb-link">ğŸŒ Website</a><button class="btn-sb-out" onclick="if(confirm('Log out?')){sessionStorage.removeItem('dv_admin');location.href='login.html';}">ğŸšª Log Out</button></div></div><div class="main"><div class="topbar"><h1>ğŸ‘¥ Customers</h1><div class="tr"><button class="btn btn-primary" onclick="openM('mNewC')">â• Add Customer</button><button class="btn btn-info" onclick="exportC()">ğŸ“¥ Export</button><button class="btn btn-ghost" onclick="loadC()">ğŸ”„ Refresh</button></div></div><div class="body"><div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
  <div class="srch-w"><input type="text" id="csrch" placeholder="Name, email, reg..." oninput="renderC()"></div>
  <button class="btn btn-ghost" onclick="loadC()">ğŸ”„</button>
  <button class="btn btn-info btn-sm" onclick="exportC()">ğŸ“¥ CSV</button>
  <button class="btn btn-warning btn-sm" onclick="window.print()">ğŸ–¨ï¸ Print</button>
</div>
<div class="tbl-wrap"><table><thead><tr><th>Customer</th><th>Email</th><th>Phone</th><th>Vehicles</th><th>Bookings</th><th>Total Spent</th><th>Last Visit</th><th>Actions</th></tr></thead>
<tbody id="cTb"></tbody></table></div>
<div class="modal" id="mVwC"><div class="mbox"><h3>ğŸ‘¤ Customer Profile</h3><div id="mVwCB"></div>
<div class="mfoot"><button class="btn btn-ghost" onclick="closeM('mVwC')">Close</button>
<button class="btn btn-primary" onclick="closeM('mVwC')">ğŸ’° New Invoice</button>
<button class="btn btn-info" onclick="closeM('mVwC');location.href='admin.html'">ğŸ“… Bookings</button></div></div></div>
<div class="modal" id="mNewC"><div class="mbox"><h3>â• Add Manual Customer</h3>
<div class="g2"><div class="fg"><label>Name *</label><input type="text" id="ncN"></div><div class="fg"><label>Phone *</label><input type="tel" id="ncP"></div></div>
<div class="fg"><label>Email *</label><input type="email" id="ncE"></div>
<div class="g2"><div class="fg"><label>Car Reg</label><input type="text" id="ncR" placeholder="AB12 CDE"></div><div class="fg"><label>Car Make/Model</label><input type="text" id="ncM" placeholder="Ford Focus"></div></div>
<div class="fg"><label>Notes</label><textarea id="ncX"></textarea></div>
<div class="mfoot"><button class="btn btn-ghost" onclick="closeM('mNewC')">Cancel</button><button class="btn btn-primary" onclick="saveNewC()">Save</button></div></div></div></div></div><div class="modal" id="mDel"><div class="mbox" style="max-width:370px"><h3>ğŸ—‘ï¸ Confirm Delete</h3><p id="mDelMsg" style="color:#555;margin-bottom:4px">This cannot be undone.</p><div class="mfoot"><button class="btn btn-ghost" onclick="closeM('mDel')">Cancel</button><button class="btn btn-danger" id="mDelBtn">Yes, Delete</button></div></div></div><script src="shared.js"></script><script>
let cData=[];
async function loadC(){
  const[bk,inv]=await Promise.all([dbGet("bookings"),dbGet("invoices")]);
  const mp={};
  bk.forEach(b=>{if(!mp[b.email])mp[b.email]={name:b.name,email:b.email,phone:b.phone||"â€”",regs:[],bkCount:0,spent:0,lastDate:""};
  const c=mp[b.email];c.bkCount++;if(!c.regs.includes(b.reg))c.regs.push(b.reg);if(!c.lastDate||b.date>c.lastDate)c.lastDate=b.date;});
  inv.forEach(i=>{if(mp[i.customer_email])mp[i.customer_email].spent+=(i.total_amount||0);});
  cData=Object.values(mp);renderC();
}
function renderC(){
  const q=document.getElementById("csrch").value.toLowerCase();
  const f=cData.filter(c=>(c.name||"").toLowerCase().includes(q)||(c.email||"").toLowerCase().includes(q)||(c.regs.join(" ")).toLowerCase().includes(q));
  const tb=document.getElementById("cTb");tb.innerHTML="";
  if(!f.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="ei">ğŸ‘¥</div><p>No customers found</p></div></td></tr>`;return;}
  f.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><strong>${c.name}</strong></td><td style="font-size:.8rem">${c.email}</td><td>${c.phone}</td>
      <td>${c.regs.map(r=>`<span class="badge b-dk" style="margin:1px">${r}</span>`).join("")}</td>
      <td><span class="badge b-in">${c.bkCount}</span></td>
      <td><strong style="color:var(--ac)">${fmtGBP(c.spent)}</strong></td>
      <td style="color:#888;font-size:.8rem">${c.lastDate?fmtD(c.lastDate):"â€”"}</td>
      <td>
        <button class="btn btn-dark btn-sm" onclick='viewC(${JSON.stringify(c).replace(/'/g,"&apos;")})'>ğŸ‘¤</button>
        <button class="btn btn-primary btn-sm" onclick='preInv("${c.name}","${c.email}")'>ğŸ’°</button>
        <a href="mailto:${c.email}" class="btn btn-info btn-sm">ğŸ“§</a>
        <a href="tel:${c.phone}" class="btn btn-success btn-sm">ğŸ“</a>
      </td>`;
    tb.appendChild(tr);
  });
}
function viewC(c){document.getElementById("mVwCB").innerHTML=`<div class="ir"><span class="lbl">Name</span><span class="val">${c.name}</span></div><div class="ir"><span class="lbl">Email</span><span class="val">${c.email}</span></div><div class="ir"><span class="lbl">Phone</span><span class="val">${c.phone}</span></div><div class="ir"><span class="lbl">Vehicles</span><span class="val">${c.regs.join(", ")}</span></div><div class="ir"><span class="lbl">Bookings</span><span class="val">${c.bkCount}</span></div><div class="ir hi"><span class="lbl">Total Spent</span><span class="val" style="color:var(--ac);font-weight:700">${fmtGBP(c.spent)}</span></div><div class="ir"><span class="lbl">Last Visit</span><span class="val">${c.lastDate?fmtD(c.lastDate):"â€”"}</span></div>`;openM("mVwC");}
function preInv(n,e){sessionStorage.setItem("inv_pre",JSON.stringify({customer_name:n,customer_email:e}));location.href="invoices.html";}
function exportC(){
  const rows=[["Name","Email","Phone","Regs","Bookings","Total Spent","Last Visit"]];
  cData.forEach(c=>rows.push([c.name,c.email,c.phone,c.regs.join("|"),c.bkCount,c.spent.toFixed(2),c.lastDate||""]));
  const csv=rows.map(r=>r.map(x=>`"${x||""}"`).join(",")).join("
");
  const a=document.createElement("a");a.href="data:text/csv,"+encodeURIComponent(csv);a.download="customers.csv";a.click();
}
async function saveNewC(){
  const n=document.getElementById("ncN").value.trim(),e=document.getElementById("ncE").value.trim(),p=document.getElementById("ncP").value.trim();
  if(!n||!e||!p){toast("Fill required fields","er");return;}
  await dbIns("bookings",{name:n,email:e,phone:p,reg:document.getElementById("ncR").value||"MANUAL",car:document.getElementById("ncM").value,date:today(),notes:document.getElementById("ncX").value,status:"pending",viewed:true});
  closeM("mNewC");loadC();toast("Customer added!");
}
loadC();
</script></body></html>