<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>DeltaV â€” ğŸ“ˆ Finance</title>
<link rel="stylesheet" href="theme.css">
<style></style>
</head>
<body>
<script>if(sessionStorage.getItem("dv_admin")!=="1"){location.href="login.html";}</script>
<div class="sidebar">
  <div class="sb-logo">DeltaV <span>Auto</span><small>Admin Panel</small></div>
  <nav><div class="sb-sec">Core</div><a href="dashboard.html" class=""><span class="ni">ğŸ“Š</span>Dashboard</a>
<a href="admin.html" class=""><span class="ni">ğŸ“…</span>Bookings</a>
<a href="schedule.html" class=""><span class="ni">ğŸ—“ï¸</span>Schedule</a>
<a href="customers.html" class=""><span class="ni">ğŸ‘¥</span>Customers</a>
<a href="invoices.html" class=""><span class="ni">ğŸ’°</span>Invoices</a>
<div class="sb-sec">Stock & Money</div><a href="inventory.html" class=""><span class="ni">ğŸ“¦</span>Inventory</a>
<a href="payments.html" class=""><span class="ni">ğŸ’³</span>Payments</a>
<a href="finance.html" class="active"><span class="ni">ğŸ“ˆ</span>Finance</a>
<a href="workers.html" class=""><span class="ni">ğŸ‘·</span>Workers</a>
<div class="sb-sec">Operations</div><a href="jobs.html" class=""><span class="ni">ğŸ”©</span>Job Cards</a>
<a href="quotes.html" class=""><span class="ni">ğŸ“‹</span>Quotes</a>
<a href="suppliers.html" class=""><span class="ni">ğŸ­</span>Suppliers</a>
<a href="expenses.html" class=""><span class="ni">ğŸ§¾</span>Expenses</a>
<a href="reports.html" class=""><span class="ni">ğŸ“‰</span>Reports</a>
<div class="sb-sec">Comms & Tools</div><a href="messages.html" class=""><span class="ni">ğŸ’¬</span>Messages</a>
<a href="notes.html" class=""><span class="ni">ğŸ“</span>Notes</a>
<a href="reminders.html" class=""><span class="ni">ğŸ””</span>Reminders</a>
<a href="vehicles.html" class=""><span class="ni">ğŸš—</span>Vehicle DB</a>
<a href="tasks.html" class=""><span class="ni">âœ…</span>Tasks</a>
<a href="timesheets.html" class=""><span class="ni">â±ï¸</span>Timesheets</a>
<div class="sb-sec">Extra</div><a href="warranties.html" class=""><span class="ni">ğŸ›¡ï¸</span>Warranties</a>
<a href="promotions.html" class=""><span class="ni">ğŸ</span>Promotions</a>
<a href="feedback.html" class=""><span class="ni">â­</span>Feedback</a>
<a href="returns.html" class=""><span class="ni">â†©ï¸</span>Returns</a>
<a href="waiting.html" class=""><span class="ni">â³</span>Waiting List</a>
<a href="checklist.html" class=""><span class="ni">â˜‘ï¸</span>Checklists</a>
<a href="targets.html" class=""><span class="ni">ğŸ¯</span>Targets</a>
<a href="audit.html" class=""><span class="ni">ğŸ”</span>Audit Log</a>
<a href="gallery_mgr.html" class=""><span class="ni">ğŸ“¸</span>Gallery Mgr</a>
<div class="sb-sec">Advanced</div><a href="sms.html" class=""><span class="ni">ğŸ“±</span>SMS / Email</a>
<a href="loyalty.html" class=""><span class="ni">ğŸ…</span>Loyalty</a>
<a href="parts_orders.html" class=""><span class="ni">ğŸ›’</span>Parts Orders</a>
<a href="MOT.html" class=""><span class="ni">ğŸ”–</span>MOT Tracker</a>
<a href="service_history.html" class=""><span class="ni">ğŸ“œ</span>Svc History</a>
<a href="staff_rota.html" class=""><span class="ni">ğŸ“†</span>Staff Rota</a>
<a href="hours.html" class=""><span class="ni">â°</span>Opening Hours</a>
<a href="settings.html" class=""><span class="ni">âš™ï¸</span>Settings</a>
</nav>
  <div class="sb-foot">
    <a href="index.html" class="btn-sb-link">ğŸŒ Website</a>
    <button class="btn-sb-out" onclick="if(confirm('Log out?')){sessionStorage.removeItem('dv_admin');location.href='login.html';}">ğŸšª Log Out</button>
  </div>
</div>
<div class="main">
  <div class="topbar"><h1>ğŸ“ˆ Finance</h1><div class="tr"><button class="btn btn-primary" onclick="openM('mNewTx')">+ Add Transaction</button><button class="btn btn-info" onclick="exportFin()">ğŸ“¥ Export</button><button class="btn btn-ghost" onclick="loadFin()">ğŸ”„ Refresh</button></div></div>
  <div class="body">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:28px">
  <div class="stat-card stat-card-success">
    <div class="stat-label">ğŸ’° Total Income</div>
    <div class="stat-value" id="fIn" style="font-size:1.8rem;color:var(--ok)">Â£0</div>
    <div class="stat-sub">All transactions</div>
  </div>
  <div class="stat-card stat-card-danger">
    <div class="stat-label">ğŸ“‰ Total Expenses</div>
    <div class="stat-value" id="fOut" style="font-size:1.8rem;color:var(--er)">Â£0</div>
    <div class="stat-sub">All outgoing</div>
  </div>
  <div class="stat-card stat-card-primary">
    <div class="stat-label">ğŸ“Š Net Profit</div>
    <div class="stat-value" id="fNet" style="font-size:1.8rem;color:var(--ac)">Â£0</div>
    <div class="stat-sub">Bottom line</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">ğŸ“… This Month</div>
    <div class="stat-value" id="fMo" style="font-size:1.6rem">Â£0</div>
    <div class="stat-sub" id="fMoSub"></div>
  </div>
</div>
<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
  <div class="srch-w"><input type="text" id="fsrch" placeholder="Search description..." oninput="renderFin()"></div>
  <select id="fType" class="btn btn-ghost" onchange="renderFin()" style="padding:9px 12px;font-size:.82rem">
    <option value="">All Types</option><option value="income">Income</option><option value="expense">Expense</option>
  </select>
  <button class="btn btn-primary" onclick="openM('mNewTx')">+ Add</button>
  <button class="btn btn-info btn-sm" onclick="exportFin()">ğŸ“¥ Export</button>
  <button class="btn btn-ghost" onclick="loadFin()">ğŸ”„</button>
</div>
<div style="display:flex;flex-direction:column;gap:8px" id="finList"></div>
</tr></thead><tbody id="finTb"></tbody></table></div>

<div class="modal" id="mNewTx"><div class="mbox">
  <h3>ğŸ’° Add Transaction</h3>
  <div class="g2">
    <div class="fg"><label>Date *</label><input type="date" id="txDt"></div>
    <div class="fg"><label>Type *</label>
      <select id="txType"><option value="income">Income</option><option value="expense">Expense</option></select>
    </div>
  </div>
  <div class="g2">
    <div class="fg"><label>Category *</label>
      <select id="txCat">
        <option>Parts Purchase</option><option>Staff Wages</option><option>Overheads</option>
        <option>Equipment</option><option>Invoice Payment</option><option>Rent/Utilities</option>
        <option>Insurance</option><option>Tools</option><option>Marketing</option><option>Other</option>
      </select>
    </div>
    <div class="fg"><label>Amount (Â£) *</label><input type="number" id="txAmt" placeholder="0.00" min="0" step="0.01"></div>
  </div>
  <div class="fg"><label>Description *</label><input type="text" id="txDesc" placeholder="Brief description"></div>
  <div class="fg"><label>Reference</label><input type="text" id="txRef" placeholder="Invoice ref, receipt no..."></div>
  <div class="fg"><label>Notes</label><textarea id="txNote"></textarea></div>
  <div class="mfoot">
    <button class="btn btn-ghost" onclick="closeM('mNewTx')">Cancel</button>
    <button class="btn btn-primary" onclick="saveTx()">ğŸ’¾ Save</button>
  </div>
</div></div>
</div>
</div>
<div class="modal" id="mDel"><div class="mbox" style="max-width:360px">
  <h3>ğŸ—‘ï¸ Confirm Delete</h3>
  <p id="mDelMsg" style="color:#555;margin-bottom:4px">This cannot be undone.</p>
  <div class="mfoot">
    <button class="btn btn-ghost" onclick="closeM('mDel')">Cancel</button>
    <button class="btn btn-danger" id="mDelBtn">Yes, Delete</button>
  </div>
</div></div>
<script src="shared.js"></script>
<script>
let finData=[],finEdit=null;
async function loadFin(){finData=await dbGet("transactions","&order=tx_date.desc");renderFin();updateFinStats();}
function updateFinStats(){
  const mn=today().slice(0,7);
  const inc=finData.filter(t=>t.type==="income").reduce((s,t)=>s+(t.amount||0),0);
  const exp=finData.filter(t=>t.type==="expense").reduce((s,t)=>s+(t.amount||0),0);
  const parts=finData.filter(t=>t.category==="Parts Purchase").reduce((s,t)=>s+(t.amount||0),0);
  const staff=finData.filter(t=>t.category==="Staff Wages").reduce((s,t)=>s+(t.amount||0),0);
  const mo=finData.filter(t=>(t.tx_date||"").startsWith(mn)).reduce((s,t)=>t.type==="income"?s+(t.amount||0):s-(t.amount||0),0);
  document.getElementById("fIn").textContent=fmtGBP(inc);
  document.getElementById("fOut").textContent=fmtGBP(exp);
  const net=inc-exp;document.getElementById("fNet").textContent=fmtGBP(net);document.getElementById("fNet").style.color=net>=0?"var(--ok)":"var(--er)";
  document.getElementById("fParts").textContent=fmtGBP(parts);
  document.getElementById("fStaff").textContent=fmtGBP(staff);
  document.getElementById("fMo").textContent=fmtGBP(mo);document.getElementById("fMo").style.color=mo>=0?"var(--ok)":"var(--er)";
}
function renderFin(){
  const q=document.getElementById("fsrch").value.toLowerCase();
  const tp=document.getElementById("fType").value;
  let f=finData.filter(t=>(t.description||"").toLowerCase().includes(q)||(t.reference||"").toLowerCase().includes(q));
  if(tp)f=f.filter(t=>t.type===tp);
  const list=document.getElementById("finList");list.innerHTML="";
  if(!f.length){list.innerHTML=`<div style="padding:40px 20px;text-align:center"><div class="empty"><div class="ei">ğŸ“ˆ</div><p>No transactions found</p></div></div>`;return;}
  f.forEach(t=>{
    const color=t.type==="income"?'var(--ok)':'var(--er)';
    const item=document.createElement('div');
    item.className='card';
    item.style.borderLeft='4px solid '+color;
    item.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
      <div><div style="font-weight:600;color:#1b2b3a">${t.description}</div><div style="font-size:.8rem;color:#94a3b8">${t.category}</div></div>
      <div style="text-align:right"><div style="font-weight:700;color:${color};font-size:1.2rem">${t.type==="expense"?"-":""}${fmtGBP(t.amount)}</div><div style="font-size:.75rem;color:#94a3b8">${t.tx_date}</div></div>
    </div>
    ${t.reference?'<div style="font-size:.8rem;color:#cbd5e0;margin-bottom:8px">ğŸ“‹ Ref: '+t.reference+'</div>':''}
    ${t.notes?'<div style="font-size:.8rem;color:#94a3b8;padding:8px;background:#f8f9fb;border-radius:6px;margin-bottom:8px">'+t.notes+'</div>':''}
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn btn-warning btn-sm" onclick="editTx('${t.id}')">âœï¸</button>
      <button class="btn btn-danger btn-sm" onclick="delTx('${t.id}')">ğŸ—‘ï¸</button>
    </div>`;
    list.appendChild(item);
  });
}
async function saveTx(){
  const dt=document.getElementById("txDt").value,amt=document.getElementById("txAmt").value,desc=document.getElementById("txDesc").value.trim();
  if(!dt||!amt||!desc){toast("Fill required fields","er");return;}
  const d={tx_date:dt,type:document.getElementById("txType").value,category:document.getElementById("txCat").value,description:desc,amount:parseFloat(amt),reference:document.getElementById("txRef").value.trim()||null,notes:document.getElementById("txNote").value.trim()||null};
  if(finEdit){await dbUpd("transactions",finEdit,d);toast("Updated!");}else{await dbIns("transactions",d);toast("Transaction saved!");}
  closeM("mNewTx");loadFin();
}
function editTx(id){const t=finData.find(x=>x.id===id);if(!t)return;finEdit=id;document.getElementById("txDt").value=t.tx_date;document.getElementById("txType").value=t.type;document.getElementById("txCat").value=t.category;document.getElementById("txAmt").value=t.amount;document.getElementById("txDesc").value=t.description||"";document.getElementById("txRef").value=t.reference||"";document.getElementById("txNote").value=t.notes||"";openM("mNewTx");}
function delTx(id){confirmDel("Delete this transaction?",async()=>{await dbDel("transactions",id);finData=finData.filter(t=>t.id!==id);renderFin();updateFinStats();toast("Deleted","in");});}
function exportFin(){const rows=[["Date","Type","Category","Description","Amount","Reference"]];finData.forEach(t=>rows.push([t.tx_date,t.type,t.category,t.description,t.amount,t.reference||""]));const csv=rows.map(r=>r.map(c=>`"${c||""}"`).join(",")).join("
");const a=document.createElement("a");a.href="data:text/csv,"+encodeURIComponent(csv);a.download="finance.csv";a.click();}
document.getElementById("txDt").value=today();loadFin();
</script>
</body></html>