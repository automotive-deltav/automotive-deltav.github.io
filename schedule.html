<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>DeltaV â€” Schedule</title>
<link rel="stylesheet" href="theme.css">
<style>
.cal-head{display:grid;grid-template-columns:repeat(7,1fr);background:linear-gradient(135deg,#1b2b3a,#2e4560);border-radius:var(--r) var(--r) 0 0}
.cal-head div{padding:12px;text-align:center;color:rgba(255,255,255,.6);font-size:.7rem;font-weight:700;letter-spacing:1.2px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:0;background:#fff;border-radius:0 0 var(--r) var(--r);border:1.5px solid var(--br);border-top:none}
.cal-day{min-height:120px;border:1px solid #f0f2f5;padding:8px;background:#fff;position:relative;transition:all .18s}
.cal-day:hover{background:#f9fafb}
.cal-day.today{background:#fff5f0;border:2px solid var(--ac)}
.day-num{font-weight:700;font-size:.88rem;color:var(--dk);margin-bottom:6px}
.day-num.today{color:var(--ac);font-size:1rem}
.appt{background:#28a745;color:#fff;padding:4px 7px;border-radius:5px;font-size:.68rem;font-weight:600;margin-bottom:3px;cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;box-shadow:0 2px 5px rgba(0,0,0,.15);transition:all .15s}
.appt:hover{transform:translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,.2)}
.appt.pending{background:#ffc107;color:#333}
</style>
</head>
<body>
<script>if(sessionStorage.getItem("dv_admin")!=="1"){location.href="login.html";}</script>
<div class="sidebar">
  <div class="sb-logo">DeltaV <span>Auto</span><small>Admin Panel</small></div>
  <nav>
    <div class="sb-sec">Core</div>
    <a href="dashboard.html"><span class="ni">ğŸ“Š</span>Dashboard</a>
    <a href="admin.html"><span class="ni">ğŸ“…</span>Bookings</a>
    <a href="schedule.html" class="active"><span class="ni">ğŸ—“ï¸</span>Schedule</a>
    <a href="customers.html"><span class="ni">ğŸ‘¥</span>Customers</a>
    <a href="invoices.html"><span class="ni">ğŸ’°</span>Invoices</a>
    <div class="sb-sec">Stock & Money</div>
    <a href="inventory.html"><span class="ni">ğŸ“¦</span>Inventory</a>
    <a href="payments.html"><span class="ni">ğŸ’³</span>Payments</a>
    <a href="finance.html"><span class="ni">ğŸ“ˆ</span>Finance</a>
    <a href="workers.html"><span class="ni">ğŸ‘·</span>Workers</a>
    <div class="sb-sec">Operations</div>
    <a href="jobs.html"><span class="ni">ğŸ”©</span>Job Cards</a>
    <a href="quotes.html"><span class="ni">ğŸ“‹</span>Quotes</a>
    <a href="suppliers.html"><span class="ni">ğŸ­</span>Suppliers</a>
    <a href="expenses.html"><span class="ni">ğŸ§¾</span>Expenses</a>
    <a href="reports.html"><span class="ni">ğŸ“‰</span>Reports</a>
    <div class="sb-sec">Tools</div>
    <a href="messages.html"><span class="ni">ğŸ’¬</span>Messages</a>
    <a href="notes.html"><span class="ni">ğŸ“</span>Notes</a>
    <a href="reminders.html"><span class="ni">ğŸ””</span>Reminders</a>
    <a href="vehicles.html"><span class="ni">ğŸš—</span>Vehicle DB</a>
    <a href="settings.html"><span class="ni">âš™ï¸</span>Settings</a>
  </nav>
  <div class="sb-foot">
    <a href="index.html" class="btn-sb-link">ğŸŒ Website</a>
    <button class="btn-sb-out" onclick="if(confirm('Log out?')){sessionStorage.removeItem('dv_admin');location.href='login.html';}">ğŸšª Log Out</button>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <h1>ğŸ—“ï¸ Schedule</h1>
    <div class="tr">
      <button class="btn btn-ghost" onclick="loadSch()">ğŸ”„ Refresh</button>
      <a href="admin.html" class="btn btn-dark">ğŸ“… Bookings</a>
    </div>
  </div>
  <div class="body">
    <div style="display:flex;gap:10px;margin-bottom:18px;align-items:center;justify-content:center">
      <button class="btn btn-dark" onclick="prevMo()">â† Previous</button>
      <h2 id="moTitle" style="font-family:'Barlow Condensed',sans-serif;font-size:1.6rem;font-weight:700;color:var(--dk);min-width:200px;text-align:center"></h2>
      <button class="btn btn-dark" onclick="nextMo()">Next â†’</button>
      <button class="btn btn-primary" onclick="goToday()">ğŸ“… Today</button>
    </div>
    
    <div class="cal-head">
      <div>SUNDAY</div><div>MONDAY</div><div>TUESDAY</div><div>WEDNESDAY</div><div>THURSDAY</div><div>FRIDAY</div><div>SATURDAY</div>
    </div>
    <div class="cal-grid" id="calGrid"></div>

    <div class="modal" id="mAppt">
      <div class="mbox">
        <h3>ğŸ“‹ Appointment Details</h3>
        <div id="mApptBody"></div>
        <div class="mfoot">
          <button class="btn btn-ghost" onclick="closeM('mAppt')">Close</button>
          <a href="admin.html" class="btn btn-primary">â†’ Manage Booking</a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="mDel"><div class="mbox" style="max-width:360px"><h3>ğŸ—‘ï¸ Confirm Delete</h3><p id="mDelMsg" style="color:#555">This cannot be undone.</p><div class="mfoot"><button class="btn btn-ghost" onclick="closeM('mDel')">Cancel</button><button class="btn btn-danger" id="mDelBtn">Yes, Delete</button></div></div></div>

<script src="shared.js"></script>
<script>
let curMonth=new Date().getMonth();
let curYear=new Date().getFullYear();
let bookings=[];
const MONTHS=["January","February","March","April","May","June","July","August","September","October","November","December"];

async function loadSch(){
  try{
    bookings=await dbGet("bookings");
    renderCal();
  }catch(e){
    console.error(e);
    toast("Failed to load schedule","er");
  }
}

function renderCal(){
  document.getElementById("moTitle").textContent=`${MONTHS[curMonth]} ${curYear}`;
  const firstDay=new Date(curYear,curMonth,1).getDay();
  const daysInMonth=new Date(curYear,curMonth+1,0).getDate();
  const today=new Date().toISOString().split("T")[0];
  
  const grid=document.getElementById("calGrid");
  grid.innerHTML="";
  
  // Empty cells before month starts
  for(let i=0;i<firstDay;i++){
    const cell=document.createElement("div");
    cell.className="cal-day";
    cell.style.background="#fafafa";
    grid.appendChild(cell);
  }
  
  // Days of month
  for(let day=1;day<=daysInMonth;day++){
    const dateStr=`${curYear}-${String(curMonth+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
    const isToday=dateStr===today;
    
    const cell=document.createElement("div");
    cell.className="cal-day"+(isToday?" today":"");
    
    const dayNum=document.createElement("div");
    dayNum.className="day-num"+(isToday?" today":"");
    dayNum.textContent=day;
    cell.appendChild(dayNum);
    
    // Find appointments for this day
    const dayBookings=bookings.filter(b=>(b.confirmed_date||b.date)===dateStr);
    dayBookings.forEach(b=>{
      const appt=document.createElement("div");
      appt.className="appt "+(b.status==="confirmed"?"":"pending");
      appt.textContent=(b.confirmed_time?b.confirmed_time.slice(0,5)+" ":"")+b.name;
      appt.title=`${b.name} â€” ${b.reg} â€” ${b.service||"General"}`;
      appt.onclick=()=>showAppt(b);
      cell.appendChild(appt);
    });
    
    grid.appendChild(cell);
  }
}

function showAppt(b){
  document.getElementById("mApptBody").innerHTML=`
    <div class="ir"><span class="lbl">Customer</span><span class="val">${b.name}</span></div>
    <div class="ir"><span class="lbl">Phone</span><span class="val">${b.phone||"â€”"}</span></div>
    <div class="ir"><span class="lbl">Email</span><span class="val">${b.email}</span></div>
    <div class="ir"><span class="lbl">Registration</span><span class="val">${b.reg}</span></div>
    <div class="ir"><span class="lbl">Service</span><span class="val">${b.service||"â€”"}</span></div>
    <div class="ir"><span class="lbl">Date</span><span class="val">${b.confirmed_date||b.date}</span></div>
    <div class="ir"><span class="lbl">Time</span><span class="val">${b.confirmed_time?b.confirmed_time.slice(0,5):"Not set"}</span></div>
    <div class="ir"><span class="lbl">Status</span><span class="val">${b.status}</span></div>`;
  openM("mAppt");
}

function prevMo(){curMonth--;if(curMonth<0){curMonth=11;curYear--;}renderCal();}
function nextMo(){curMonth++;if(curMonth>11){curMonth=0;curYear++;}renderCal();}
function goToday(){const d=new Date();curMonth=d.getMonth();curYear=d.getFullYear();renderCal();}

loadSch();
</script>
</body>
</html>
