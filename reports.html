<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>DeltaV â€” ğŸ“‰ Reports</title><link rel="stylesheet" href="theme.css"><style></style></head><body><script>if(sessionStorage.getItem("dv_admin")!=="1"){location.href="login.html";}</script><div class="sidebar"><div class="sb-logo">DeltaV <span>Auto</span><small>Admin Panel</small></div><nav><div class="sb-sec">Core</div><a href="dashboard.html" class=""><span class="ni">ğŸ“Š</span>Dashboard</a><a href="admin.html" class=""><span class="ni">ğŸ“…</span>Bookings</a><a href="schedule.html" class=""><span class="ni">ğŸ—“ï¸</span>Schedule</a><a href="customers.html" class=""><span class="ni">ğŸ‘¥</span>Customers</a><a href="invoices.html" class=""><span class="ni">ğŸ’°</span>Invoices</a><div class="sb-sec">Stock & Money</div><a href="inventory.html" class=""><span class="ni">ğŸ“¦</span>Inventory</a><a href="payments.html" class=""><span class="ni">ğŸ’³</span>Payments</a><a href="finance.html" class=""><span class="ni">ğŸ“ˆ</span>Finance</a><a href="workers.html" class=""><span class="ni">ğŸ‘·</span>Workers</a><div class="sb-sec">Operations</div><a href="jobs.html" class=""><span class="ni">ğŸ”©</span>Job Cards</a><a href="quotes.html" class=""><span class="ni">ğŸ“‹</span>Quotes</a><a href="suppliers.html" class=""><span class="ni">ğŸ­</span>Suppliers</a><a href="expenses.html" class=""><span class="ni">ğŸ§¾</span>Expenses</a><a href="reports.html" class="active"><span class="ni">ğŸ“‰</span>Reports</a><div class="sb-sec">Comms & Tools</div><a href="messages.html" class=""><span class="ni">ğŸ’¬</span>Messages</a><a href="notes.html" class=""><span class="ni">ğŸ“</span>Notes</a><a href="reminders.html" class=""><span class="ni">ğŸ””</span>Reminders</a><a href="vehicles.html" class=""><span class="ni">ğŸš—</span>Vehicle DB</a><a href="tasks.html" class=""><span class="ni">âœ…</span>Tasks</a><a href="timesheets.html" class=""><span class="ni">â±ï¸</span>Timesheets</a><div class="sb-sec">Extra</div><a href="warranties.html" class=""><span class="ni">ğŸ›¡ï¸</span>Warranties</a><a href="promotions.html" class=""><span class="ni">ğŸ</span>Promotions</a><a href="feedback.html" class=""><span class="ni">â­</span>Feedback</a><a href="returns.html" class=""><span class="ni">â†©ï¸</span>Returns</a><a href="waiting.html" class=""><span class="ni">â³</span>Waiting List</a><a href="checklist.html" class=""><span class="ni">â˜‘ï¸</span>Checklists</a><a href="targets.html" class=""><span class="ni">ğŸ¯</span>Targets</a><a href="audit.html" class=""><span class="ni">ğŸ”</span>Audit Log</a><a href="gallery_mgr.html" class=""><span class="ni">ğŸ“¸</span>Gallery Mgr</a><div class="sb-sec">Advanced</div><a href="sms.html" class=""><span class="ni">ğŸ“±</span>SMS / Email</a><a href="loyalty.html" class=""><span class="ni">ğŸ…</span>Loyalty</a><a href="parts_orders.html" class=""><span class="ni">ğŸ›’</span>Parts Orders</a><a href="MOT.html" class=""><span class="ni">ğŸ”–</span>MOT Tracker</a><a href="service_history.html" class=""><span class="ni">ğŸ“œ</span>Svc History</a><a href="staff_rota.html" class=""><span class="ni">ğŸ“†</span>Staff Rota</a><a href="hours.html" class=""><span class="ni">â°</span>Opening Hours</a><a href="settings.html" class=""><span class="ni">âš™ï¸</span>Settings</a></nav><div class="sb-foot"><a href="index.html" class="btn-sb-link">ğŸŒ Website</a><button class="btn-sb-out" onclick="if(confirm('Log out?')){sessionStorage.removeItem('dv_admin');location.href='login.html';}">ğŸšª Log Out</button></div></div><div class="main"><div class="topbar"><h1>ğŸ“‰ Reports</h1><div class="tr"><button class="btn btn-primary" onclick="genRep()">ğŸ“Š Generate Report</button><button class="btn btn-info" onclick="exportRep()">ğŸ“¥ Export</button><button class="btn btn-ghost" onclick="loadRep()">ğŸ”„ Refresh</button></div></div><div class="body"><div class="card-flat" style="margin-bottom:20px">
  <h3 style="margin-bottom:14px">ğŸ“… Select Report Period</h3>
  <div class="g3">
    <div class="fg"><label>From Date</label><input type="date" id="rFrom"></div>
    <div class="fg"><label>To Date</label><input type="date" id="rTo"></div>
    <div style="display:flex;align-items:flex-end;padding-bottom:14px">
      <button class="btn btn-primary btn-fw" onclick="genRep()">ğŸ“Š Generate</button>
    </div>
  </div>
</div>

<div class="stat-grid" id="repStats">
  <div class="card"><div class="card-title">ğŸ’° Total Revenue</div><div class="card-val" id="rRev">â€”</div><div class="card-sub">Paid invoices</div></div>
  <div class="card"><div class="card-title">ğŸ“… Bookings</div><div class="card-val" id="rBk">â€”</div><div class="card-sub">Total bookings</div></div>
  <div class="card"><div class="card-title">ğŸ’³ Payments</div><div class="card-val" id="rPay">â€”</div><div class="card-sub">Total received</div></div>
  <div class="card"><div class="card-title">ğŸ“¦ Parts Sold</div><div class="card-val" id="rParts">â€”</div><div class="card-sub">Inventory items</div></div>
  <div class="card"><div class="card-title">ğŸ“‰ Expenses</div><div class="card-val" id="rExp" style="color:var(--er)">â€”</div><div class="card-sub">Total spent</div></div>
  <div class="card"><div class="card-title">ğŸ“ˆ Net Profit</div><div class="card-val" id="rProf">â€”</div><div class="card-sub">Revenue - Expenses</div></div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:20px">
  <div class="card-flat">
    <h3 style="margin-bottom:12px">ğŸ† Top Services</h3>
    <div id="topSrvs"></div>
  </div>
  <div class="card-flat">
    <h3 style="margin-bottom:12px">ğŸ‘¥ Top Customers</h3>
    <div id="topCust"></div>
  </div>
</div></div></div><div class="modal" id="mDel"><div class="mbox" style="max-width:360px"><h3>ğŸ—‘ï¸ Confirm Delete</h3><p id="mDelMsg" style="color:#555">This cannot be undone.</p><div class="mfoot"><button class="btn btn-ghost" onclick="closeM('mDel')">Cancel</button><button class="btn btn-danger" id="mDelBtn">Yes, Delete</button></div></div></div><script src="shared.js"></script><script>
const td=new Date().toISOString().split("T")[0];
const fm=new Date();fm.setMonth(fm.getMonth()-1);
document.getElementById("rFrom").value=fm.toISOString().split("T")[0];
document.getElementById("rTo").value=td;

async function genRep(){
  const f=document.getElementById("rFrom").value;
  const t=document.getElementById("rTo").value;
  if(!f||!t){toast("Select date range","er");return;}
  
  const[inv,bk,pay,invt,tx]=await Promise.all([
    dbGet("invoices",`&invoice_date=gte.${f}&invoice_date=lte.${t}`),
    dbGet("bookings",`&date=gte.${f}&date=lte.${t}`),
    dbGet("payments",`&payment_date=gte.${f}&payment_date=lte.${t}`),
    dbGet("inventory",`&purchase_date=gte.${f}&purchase_date=lte.${t}&status=eq.sold`),
    dbGet("transactions",`&tx_date=gte.${f}&tx_date=lte.${t}&type=eq.expense`)
  ]);
  
  const rev=inv.filter(i=>i.payment_status==="paid").reduce((s,i)=>s+(i.total_amount||0),0);
  const payTotal=pay.reduce((s,p)=>s+(p.amount||0),0);
  const exp=tx.reduce((s,t)=>s+(t.amount||0),0);
  const prof=rev-exp;
  
  document.getElementById("rRev").textContent="Â£"+rev.toFixed(2);
  document.getElementById("rBk").textContent=bk.length;
  document.getElementById("rPay").textContent="Â£"+payTotal.toFixed(2);
  document.getElementById("rParts").textContent=invt.length;
  document.getElementById("rExp").textContent="Â£"+exp.toFixed(2);
  document.getElementById("rProf").textContent="Â£"+prof.toFixed(2);
  document.getElementById("rProf").style.color=prof>=0?"var(--ok)":"var(--er)";
  
  // Top services
  const srvMap={};
  bk.forEach(b=>{const s=b.service||"General";srvMap[s]=(srvMap[s]||0)+1;});
  const srvs=Object.entries(srvMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
  document.getElementById("topSrvs").innerHTML=srvs.map(([s,c])=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f2f5"><span>${s}</span><strong>${c}</strong></div>`).join("")||"<p style='color:#aaa'>No data</p>";
  
  // Top customers (by spend)
  const custMap={};
  inv.filter(i=>i.payment_status==="paid").forEach(i=>custMap[i.customer_name]=(custMap[i.customer_name]||0)+(i.total_amount||0));
  const custs=Object.entries(custMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
  document.getElementById("topCust").innerHTML=custs.map(([n,a])=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f2f5"><span>${n}</span><strong style="color:var(--ac)">Â£${a.toFixed(2)}</strong></div>`).join("")||"<p style='color:#aaa'>No data</p>";
  
  toast("Report generated!","ok");
}

function exportRep(){
  const f=document.getElementById("rFrom").value;
  const t=document.getElementById("rTo").value;
  alert(`Export report for ${f} to ${t}

Feature: Generate PDF report with charts and summary.`);
}

function loadRep(){genRep();}
genRep();
</script></body></html>