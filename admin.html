<script src="shared.js"></script>
<script>
let data=[];
let firstLoad=true;

async function loadData(){
  const newData = await dbGet("bookings","&order=date.desc");

  if(firstLoad){
    data=newData;
    renderData(true);
    firstLoad=false;
    return;
  }

  if(JSON.stringify(newData)!==JSON.stringify(data)){
    data=newData;
    renderData(false);
  }
}

function renderData(withAnimation=true){
  const srchEl=document.getElementById("srch");
  const statusEl=document.getElementById("statusFilter");
  const grid=document.getElementById("cardGrid");

  if(!srchEl || !statusEl || !grid) return;

  const q=srchEl.value.toLowerCase();
  const status=statusEl.value;

  let f=data.filter(r=>Object.values(r).some(v=>String(v||"").toLowerCase().includes(q)));
  if(status)f=f.filter(r=>r.status===status);

  grid.innerHTML="";

  if(!f.length){
    grid.innerHTML='<div style="grid-column:1/-1;padding:60px 20px;text-align:center"><div class="empty"><div class="ei">ğŸ“…</div><h3>No bookings found</h3><p>Bookings will appear here</p></div></div>';
    return;
  }

  f.forEach((r,idx)=>{
    const statusColor=r.status==='confirmed'?'var(--ok)':r.status==='pending'?'var(--wa)':'var(--in)';
    const card=document.createElement("div");
    card.className="card";
    card.style.borderLeft="4px solid "+statusColor;
    card.style.cursor="pointer";
    card.style.transition="all .3s ease";
    if(withAnimation){
      card.style.animation=`fadeInUp .3s ease-out ${idx*0.05}s backwards`;
    }

    card.onmouseover=function(){
      this.style.transform="translateY(-4px)";
      this.style.boxShadow="0 8px 24px rgba(0,0,0,.12)";
    };
    card.onmouseout=function(){
      this.style.transform="translateY(0)";
      this.style.boxShadow="var(--s2)";
    };

    card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
      <div style="flex:1">
        <div style="font-weight:700;color:#1b2b3a">${r.name}</div>
        <div style="font-size:.8rem;color:#94a3b8">${r.email}</div>
      </div>
      <span style="display:inline-block;padding:4px 8px;border-radius:4px;font-size:.7rem;font-weight:600;background:${statusColor};color:#fff">${r.status||'pending'}</span>
    </div>
    <div style="margin:12px 0;padding:12px;background:#f8f9fb;border-radius:8px;cursor:pointer;transition:all .2s" onclick="this.parentElement.querySelector('[data-expanded]').click()">
      <div style="color:#64748b;font-size:.8rem;margin-bottom:4px">ğŸš— Vehicle</div>
      <div style="font-weight:600;color:#1b2b3a">${r.reg}</div>
      <div style="font-size:.8rem;color:#94a3b8">${r.car||'Unknown'}</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0;font-size:.85rem">
      <div>
        <span style="color:#94a3b8">ğŸ“‹ Service</span>
        <div style="font-weight:600;color:#1b2b3a">${r.service||'General'}</div>
      </div>
      <div>
        <span style="color:#94a3b8">ğŸ“… Date</span>
        <div style="font-weight:600;color:#1b2b3a">${r.date}</div>
      </div>
    </div>
    <div style="font-size:.85rem;margin:12px 0">
      <span style="color:#94a3b8">ğŸ“ Contact</span>
      <div style="font-weight:600;color:#1b2b3a">${r.phone||'â€”'}</div>
    </div>
    <div data-expanded="false" style="display:none;padding:12px;margin:12px 0;background:#f8f9fb;border-radius:8px;border-left:3px solid var(--ac);max-height:0;overflow:hidden;transition:all .3s" id="exp-${r.id}">
      <div style="font-weight:600;margin-bottom:8px">ğŸ“ Additional Info</div>
      <div style="font-size:.8rem;color:#64748b;line-height:1.6">${r.notes||'No additional notes'}</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-primary btn-sm" onclick="viewRow('${r.id}')" style="flex:1">View</button>
      <button class="btn btn-success btn-sm" onclick="openConfirm('${r.id}','${r.name}')" ${r.status==='confirmed'?'disabled':''}>
        ${r.status==='confirmed'?'âœ“ Confirmed':'Confirm'}
      </button>
      <button class="btn btn-info btn-sm" onclick="toggleExpand('exp-${r.id}')" title="More details">â–¼</button>
      <button class="btn btn-danger btn-sm" onclick="delRow('${r.id}')">ğŸ—‘ï¸</button>
    </div>`;

    grid.appendChild(card);
  });
}

function toggleExpand(id){
  const el=document.getElementById(id);
  if(!el) return;
  const expanded=el.getAttribute("data-expanded")==="true";
  if(expanded){
    el.style.display="none";
    el.setAttribute("data-expanded","false");
  }else{
    el.style.display="block";
    el.style.maxHeight="200px";
    el.setAttribute("data-expanded","true");
  }
}

function delRow(id){
  confirmDel("Delete this booking?",async()=>{
    await dbDel("bookings",id);
    data=data.filter(x=>x.id!==id);
    renderData(false);
    toast("Deleted","in");
  });
}

function viewRow(id){
  const booking=data.find(x=>x.id===id);
  if(!booking)return;

  const html=`<div style="display:grid;gap:16px">
    <div style="background:#f8f9fb;border-radius:8px;padding:16px;border-left:4px solid var(--ac)">
      <div style="font-size:.8rem;color:#94a3b8;margin-bottom:4px">ğŸ‘¤ Customer</div>
      <div style="font-weight:600;color:#1b2b3a;margin-bottom:6px">${booking.name}</div>
      <div style="font-size:.85rem;color:#64748b">${booking.email}<br>${booking.phone||'â€”'}</div>
    </div>
    <div style="background:#f8f9fb;border-radius:8px;padding:16px;border-left:4px solid var(--in)">
      <div style="font-size:.8rem;color:#94a3b8;margin-bottom:4px">ğŸš— Vehicle</div>
      <div style="font-weight:600;color:#1b2b3a;margin-bottom:4px">${booking.reg}</div>
      <div style="font-size:.85rem;color:#64748b">${booking.car||'Unknown Model'} â€¢ ${booking.year||'Year unknown'}</div>
    </div>
    <div style="background:#f8f9fb;border-radius:8px;padding:16px;border-left:4px solid var(--ok)">
      <div style="font-size:.8rem;color:#94a3b8;margin-bottom:4px">ğŸ”§ Service Details</div>
      <div style="font-weight:600;color:#1b2b3a;margin-bottom:4px">${booking.service||'General'}</div>
      <div style="font-size:.85rem;color:#64748b">ğŸ“… ${booking.date} ${booking.slot?'@ '+booking.slot:''}</div>
    </div>
    ${booking.notes?`<div style="background:#f8f9fb;border-radius:8px;padding:16px;border-left:4px solid var(--wa)">
      <div style="font-size:.8rem;color:#94a3b8;margin-bottom:8px">ğŸ“ Notes</div>
      <div style="font-size:.85rem;color:#64748b;line-height:1.6">${booking.notes}</div>
    </div>`:''}
    <div style="display:flex;gap:8px;align-items:center;padding:12px;background:linear-gradient(135deg,rgba(255,102,0,.08),rgba(255,102,0,.02));border-radius:8px;border:1px solid rgba(255,102,0,.2)">
      <span style="font-size:1.2rem">ğŸ“Œ</span>
      <span style="font-size:.8rem;color:#64748b"><strong>Status:</strong> 
        <span style="color:${booking.status==='confirmed'?'var(--ok)':booking.status==='completed'?'var(--in)':'var(--wa)'}; font-weight:600">
          ${booking.status||'pending'}
        </span>
      </span>
    </div>
  </div>`;

  document.getElementById("viewContent").innerHTML=html;
  openM("mView");
}

let confirmingBookingId=null;

function openConfirm(id,name){
  confirmingBookingId=id;
  document.getElementById("cfmName").value=name;
  document.getElementById("cfmDate").value=today();
  document.getElementById("cfmTime").value="09:00";
  document.getElementById("cfmNotes").value="";
  openM("mConfirm");
}

async function saveConfirm(){
  const date=document.getElementById("cfmDate").value;
  const time=document.getElementById("cfmTime").value;
  const notes=document.getElementById("cfmNotes").value.trim();

  if(!date||!time){
    toast("Date and time are required","er");
    return;
  }

  const booking=data.find(x=>x.id===confirmingBookingId);
  if(!booking)return;

  await dbUpd("bookings",confirmingBookingId,{
    status:"confirmed",
    date:date,
    slot:time,
    notes:notes||(booking.notes||"")
  });

  booking.status="confirmed";
  booking.date=date;
  booking.slot=time;
  booking.notes=notes||(booking.notes||"");

  closeM("mConfirm");
  renderData(false);
  toast("Booking confirmed!","in");
}

loadData();
setInterval(loadData,5000);
</script>
