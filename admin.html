<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>DeltaV â€” ğŸ“… Bookings</title><link rel="stylesheet" href="theme.css"><style></style></head><body><script>if(sessionStorage.getItem("dv_admin")!=="1"){location.href="login.html";}</script><div class="sidebar"><div class="sb-logo">DeltaV <span>Auto</span><small>Admin Panel</small></div><nav><div class="sb-sec">Core</div><a href="dashboard.html" class=""><span class="ni">ğŸ“Š</span>Dashboard</a><a href="admin.html" class="active"><span class="ni">ğŸ“…</span>Bookings</a><a href="schedule.html" class=""><span class="ni">ğŸ—“ï¸</span>Schedule</a><a href="customers.html" class=""><span class="ni">ğŸ‘¥</span>Customers</a><a href="invoices.html" class=""><span class="ni">ğŸ’°</span>Invoices</a><div class="sb-sec">Stock & Money</div><a href="inventory.html" class=""><span class="ni">ğŸ“¦</span>Inventory</a><a href="payments.html" class=""><span class="ni">ğŸ’³</span>Payments</a><a href="finance.html" class=""><span class="ni">ğŸ“ˆ</span>Finance</a><a href="workers.html" class=""><span class="ni">ğŸ‘·</span>Workers</a><div class="sb-sec">Operations</div><a href="jobs.html" class=""><span class="ni">ğŸ”©</span>Job Cards</a><a href="quotes.html" class=""><span class="ni">ğŸ“‹</span>Quotes</a><a href="suppliers.html" class=""><span class="ni">ğŸ­</span>Suppliers</a><a href="expenses.html" class=""><span class="ni">ğŸ§¾</span>Expenses</a><a href="reports.html" class=""><span class="ni">ğŸ“‰</span>Reports</a><div class="sb-sec">Communication</div><a href="messages.html" class=""><span class="ni">ğŸ’¬</span>Messages</a><a href="notes.html" class=""><span class="ni">ğŸ“</span>Notes</a><a href="reminders.html" class=""><span class="ni">ğŸ””</span>Reminders</a><a href="vehicles.html" class=""><span class="ni">ğŸš—</span>Vehicle DB</a><div class="sb-sec">Extra</div><a href="audit.html" class=""><span class="ni">ğŸ”</span>Audit Log</a><a href="tasks.html" class=""><span class="ni">âœ…</span>Tasks</a><a href="timesheets.html" class=""><span class="ni">â±ï¸</span>Timesheets</a><a href="warranties.html" class=""><span class="ni">ğŸ›¡ï¸</span>Warranties</a><a href="promotions.html" class=""><span class="ni">ğŸ</span>Promotions</a><a href="feedback.html" class=""><span class="ni">â­</span>Feedback</a><a href="returns.html" class=""><span class="ni">â†©ï¸</span>Returns</a><a href="waiting.html" class=""><span class="ni">â³</span>Waiting List</a><a href="checklist.html" class=""><span class="ni">â˜‘ï¸</span>Checklists</a><a href="gallery-admin.html" class=""><span class="ni">ğŸ“¸</span>Gallery Mgr</a><a href="targets.html" class=""><span class="ni">ğŸ¯</span>Targets</a><a href="settings.html" class=""><span class="ni">âš™ï¸</span>Settings</a></nav><div class="sb-foot"><a href="index.html" class="btn-sb-link">ğŸŒ Website</a><button class="btn-sb-out" onclick="if(confirm('Log out?')){sessionStorage.removeItem('dv_admin');location.href='login.html';}">ğŸšª Log Out</button></div></div><div class="main"><div class="topbar"><h1>ğŸ“… Bookings</h1><div class="tr"><button class="btn btn-ghost" onclick="fetchBk()">ğŸ”„ Refresh</button><button class="btn btn-info" onclick="exportBk()">ğŸ“¥ Export CSV</button></div></div><div class="body"><div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
  <div class="srch-w"><input type="text" id="bsrch" placeholder="Search name, reg, email..." oninput="renderBk()"></div>
  <select id="bfSt" class="btn btn-ghost" onchange="renderBk()" style="padding:9px 12px;font-size:.82rem"><option value="">All Statuses</option><option value="pending">Pending</option><option value="confirmed">Confirmed</option></select>
  <button class="btn btn-ghost" onclick="fetchBk()">ğŸ”„ Refresh</button>
  <button class="btn btn-info btn-sm" onclick="exportBk()">ğŸ“¥ CSV</button>
  <button class="btn btn-warning btn-sm" onclick="window.print()">ğŸ–¨ï¸ Print</button>
  <button class="btn btn-dark btn-sm" onclick="location.href='schedule.html'">ğŸ—“ï¸ Schedule View</button>
</div>
<div id="bGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:15px"></div>
<div class="empty" id="bEmpty" style="display:none"><div class="ei">ğŸ“…</div><h3>No Bookings Found</h3></div>
<div class="modal" id="mInsp"><div class="mbox"><h3>ğŸ“‹ Booking Details</h3><div id="mInspB"></div>
<div class="mfoot"><button class="btn btn-ghost" onclick="closeM('mInsp')">Close</button>
<button class="btn btn-success" onclick="openCfFrom()">âœ… Confirm Appt</button>
<button class="btn btn-primary" onclick="goInvFromInsp()">ğŸ’° Invoice</button></div></div></div>
<div class="modal" id="mCf"><div class="mbox"><h3>âœ… Set Appointment</h3>
<p style="background:var(--acb);border:1.5px solid var(--ac);border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:.84rem">Customer preferred: <strong id="cfPref">â€”</strong></p>
<div class="g2"><div class="fg"><label>Confirmed Date *</label><input type="date" id="cfD"></div><div class="fg"><label>Confirmed Time *</label><input type="time" id="cfT" value="09:00"></div></div>
<div class="fg"><label>Internal Note</label><input type="text" id="cfNote" placeholder="e.g. Bay 1, collect from street"></div>
<div class="mfoot"><button class="btn btn-ghost" onclick="closeM('mCf')">Cancel</button><button class="btn btn-success" onclick="submitCf()">âœ… Confirm</button></div></div></div></div></div><div class="modal" id="mDel"><div class="mbox" style="max-width:370px"><h3>ğŸ—‘ï¸ Confirm Delete</h3><p id="mDelMsg" style="color:#555;margin-bottom:4px">This cannot be undone.</p><div class="mfoot"><button class="btn btn-ghost" onclick="closeM('mDel')">Cancel</button><button class="btn btn-danger" id="mDelBtn">Yes, Delete</button></div></div></div><script src="shared.js"></script><script>
let bkData=[],cBkId=null,inspId=null;
async function fetchBk(){try{bkData=await dbGet("bookings");renderBk();}catch(e){toast("Load failed","er");}}
function renderBk(){
  const q=document.getElementById("bsrch").value.toLowerCase();
  const st=document.getElementById("bfSt").value;
  let f=bkData.filter(b=>(b.name||"").toLowerCase().includes(q)||(b.email||"").toLowerCase().includes(q)||(b.reg||"").toLowerCase().includes(q));
  if(st)f=f.filter(b=>b.status===st);
  f.sort((a,b)=>a.status==="pending"?-1:1);
  const g=document.getElementById("bGrid");g.innerHTML="";
  document.getElementById("bEmpty").style.display=f.length?"none":"block";
  f.forEach(b=>{
    const isN=!b.viewed,sc=b.status==="confirmed"?"b-ok":"b-wa";
    const ap=b.confirmed_date?`<div style="background:#eafaf1;border:1px solid #c3e6cb;border-radius:7px;padding:7px 10px;font-size:.76rem;color:#155724;font-weight:600;margin-top:6px">ğŸ“… ${b.confirmed_date} at ${fmtT(b.confirmed_time)}</div>`:"";
    const card=document.createElement("div");
    card.style="background:#fff;border-radius:var(--r);border:1.5px solid var(--br);box-shadow:var(--s2);overflow:hidden;transition:all .2s;";
    card.innerHTML=`<div style="background:linear-gradient(135deg,#1b2b3a,#2e4560);padding:12px 15px;display:flex;justify-content:space-between;align-items:center">
      <span style="color:#fff;font-weight:700;font-size:.88rem">${b.name}${isN?'<span class="badge b-or b-pulse" style="margin-left:6px;font-size:.58rem">NEW</span>':""}</span>
      <span style="background:var(--ac);color:#fff;padding:2px 8px;border-radius:5px;font-weight:700;font-size:.76rem">${b.reg}</span></div>
    <div style="padding:13px 15px">
      <div class="ir"><span class="lbl">ğŸ“§</span><span class="val">${b.email}</span></div>
      <div class="ir"><span class="lbl">ğŸ“</span><span class="val">${b.phone||"â€”"}</span></div>
      <div class="ir"><span class="lbl">ğŸ”§</span><span class="val">${b.service||"Not specified"}</span></div>
      <div class="ir" style="background:#fff5f0;border-left-color:var(--ac);font-size:.78rem;font-style:italic"><span class="lbl">Pref.</span><span class="val">${b.date} (customer choice)</span></div>
      ${ap}<div style="margin-top:7px"><span class="badge ${sc}">${(b.status||"").toUpperCase()}</span></div>
    </div>
    <div style="padding:9px 15px;border-top:1.5px solid #eef0f3;display:flex;gap:5px;flex-wrap:wrap">
      <button class="btn btn-ghost btn-sm" onclick="inspBk('${b.id}')">ğŸ” Details</button>
      ${b.status!=="confirmed"?`<button class="btn btn-success btn-sm" onclick="openCf('${b.id}','${b.date||""}')">âœ… Confirm</button>`:`<button class="btn btn-warning btn-sm" onclick="unpend('${b.id}')">â†© Pending</button>`}
      <button class="btn btn-primary btn-sm" onclick="goInv('${b.id}')">ğŸ’° Invoice</button>
      <button class="btn btn-info btn-sm" onclick="addNote('${b.id}')">ğŸ“ Note</button>
      <button class="btn btn-dark btn-sm" onclick="callCustomer('${b.phone||""}')">ğŸ“</button>
      <button class="btn btn-danger btn-sm" onclick="delBk('${b.id}')">ğŸ—‘ï¸</button>
    </div>`;
    g.appendChild(card);
    if(isN)dbUpd("bookings",b.id,{viewed:true}).catch(()=>{});
  });
}
function inspBk(id){
  const b=bkData.find(x=>x.id===id);if(!b)return;inspId=id;
  document.getElementById("mInspB").innerHTML=`
    <div class="ir"><span class="lbl">Name</span><span class="val">${b.name}</span></div>
    <div class="ir"><span class="lbl">Email</span><span class="val">${b.email}</span></div>
    <div class="ir"><span class="lbl">Phone</span><span class="val">${b.phone||"â€”"}</span></div>
    <div class="ir"><span class="lbl">Registration</span><span class="val">${b.reg}</span></div>
    <div class="ir"><span class="lbl">Vehicle</span><span class="val">${b.car||"â€”"}${b.year?" ("+b.year+")":""}</span></div>
    <div class="ir"><span class="lbl">Service</span><span class="val">${b.service||"â€”"}</span></div>
    <div class="ir ac"><span class="lbl">Preferred Date</span><span class="val">${b.date}</span></div>
    ${b.confirmed_date?`<div class="ir hi"><span class="lbl">âœ… Confirmed</span><span class="val">${b.confirmed_date} at ${fmtT(b.confirmed_time)}</span></div>`:""}
    <div class="ir"><span class="lbl">Status</span><span class="val">${b.status}</span></div>
    ${b.notes?`<div class="ir"><span class="lbl">Notes</span><span class="val">${b.notes}</span></div>`:""}`;
  openM("mInsp");
}
function openCfFrom(){if(inspId){const b=bkData.find(x=>x.id===inspId);closeM("mInsp");if(b)openCf(b.id,b.date||"");}}
function openCf(id,pref){cBkId=id;document.getElementById("cfPref").textContent=pref||"Not specified";document.getElementById("cfD").value=pref||today();document.getElementById("cfT").value="09:00";document.getElementById("cfNote").value="";openM("mCf");}
async function submitCf(){
  const d=document.getElementById("cfD").value,t=document.getElementById("cfT").value;
  if(!d||!t){toast("Set date and time","er");return;}
  await dbUpd("bookings",cBkId,{status:"confirmed",confirmed_date:d,confirmed_time:t});
  const b=bkData.find(x=>x.id===cBkId);if(b){b.status="confirmed";b.confirmed_date=d;b.confirmed_time=t;}
  renderBk();closeM("mCf");toast("Appointment confirmed! âœ…");
}
async function unpend(id){await dbUpd("bookings",id,{status:"pending",confirmed_date:null,confirmed_time:null});const b=bkData.find(x=>x.id===id);if(b){b.status="pending";b.confirmed_date=null;b.confirmed_time=null;}renderBk();toast("Marked pending","in");}
function goInv(id){const b=bkData.find(x=>x.id===id);if(!b)return;sessionStorage.setItem("inv_pre",JSON.stringify({customer_name:b.name,customer_email:b.email,car_reg:b.reg,service:b.service}));location.href="invoices.html";}
function goInvFromInsp(){if(inspId){goInv(inspId);closeM("mInsp");}}
function addNote(id){const n=prompt("Note:");if(n){dbUpd("bookings",id,{notes:n});const b=bkData.find(x=>x.id===id);if(b)b.notes=n;toast("Note saved!");}}
function callCustomer(ph){if(ph)window.open("tel:"+ph);}
function delBk(id){confirmDel("Delete this booking?",async()=>{await dbDel("bookings",id);bkData=bkData.filter(b=>b.id!==id);renderBk();toast("Deleted","in");});}
function exportBk(){
  const rows=[["Name","Email","Phone","Reg","Vehicle","Service","Preferred Date","Confirmed Date","Time","Status","Notes"]];
  bkData.forEach(b=>rows.push([b.name,b.email,b.phone,b.reg,b.car||"",b.service||"",b.date,b.confirmed_date||"",b.confirmed_time||"",b.status,b.notes||""]));
  const csv=rows.map(r=>r.map(c=>`"${(c||"").toString().replace(/"/g,'""')}"`).join(",")).join("
");
  const a=document.createElement("a");a.href="data:text/csv,"+encodeURIComponent(csv);a.download="bookings.csv";a.click();
}
fetchBk();setInterval(fetchBk,15000);
</script></body></html>