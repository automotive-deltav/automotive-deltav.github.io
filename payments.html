<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>DeltaV â€” ğŸ’³ Payments</title>
<link rel="stylesheet" href="theme.css">
<style></style>
</head>
<body>
<script>if(sessionStorage.getItem("dv_admin")!=="1"){location.href="login.html";}</script>
<div class="sidebar">
  <div class="sb-logo">DeltaV <span>Auto</span><small>Admin Panel</small></div>
  <nav><div class="sb-sec">Core</div><a href="dashboard.html" class=""><span class="ni">ğŸ“Š</span>Dashboard</a>
<a href="admin.html" class=""><span class="ni">ğŸ“…</span>Bookings</a>
<a href="schedule.html" class=""><span class="ni">ğŸ—“ï¸</span>Schedule</a>
<a href="customers.html" class=""><span class="ni">ğŸ‘¥</span>Customers</a>
<a href="contact_inquiries.html" class=""><span class="ni">ğŸ“§</span>Contact Inquiries</a>
<a href="invoices.html" class=""><span class="ni">ğŸ’°</span>Invoices</a>
<div class="sb-sec">Stock & Money</div><a href="inventory.html" class=""><span class="ni">ğŸ“¦</span>Inventory</a>
<a href="payments.html" class="active"><span class="ni">ğŸ’³</span>Payments</a>
<a href="finance.html" class=""><span class="ni">ğŸ“ˆ</span>Finance</a>
<a href="workers.html" class=""><span class="ni">ğŸ‘·</span>Workers</a>
<div class="sb-sec">Operations</div><a href="jobs.html" class=""><span class="ni">ğŸ”©</span>Job Cards</a>
<a href="quotes.html" class=""><span class="ni">ğŸ“‹</span>Quotes</a>
<a href="suppliers.html" class=""><span class="ni">ğŸ­</span>Suppliers</a>
<a href="expenses.html" class=""><span class="ni">ğŸ§¾</span>Expenses</a>
<a href="reports.html" class=""><span class="ni">ğŸ“‰</span>Reports</a>
<div class="sb-sec">Comms & Tools</div><a href="messages.html" class=""><span class="ni">ğŸ’¬</span>Messages</a>
<a href="notes.html" class=""><span class="ni">ğŸ“</span>Notes</a>
<a href="reminders.html" class=""><span class="ni">ğŸ””</span>Reminders</a>
<a href="vehicles.html" class=""><span class="ni">ğŸš—</span>Vehicle DB</a>
<a href="tasks.html" class=""><span class="ni">âœ…</span>Tasks</a>
<a href="timesheets.html" class=""><span class="ni">â±ï¸</span>Timesheets</a>
<div class="sb-sec">Extra</div><a href="warranties.html" class=""><span class="ni">ğŸ›¡ï¸</span>Warranties</a>
<a href="promotions.html" class=""><span class="ni">ğŸ</span>Promotions</a>
<a href="feedback.html" class=""><span class="ni">â­</span>Feedback</a>
<a href="returns.html" class=""><span class="ni">â†©ï¸</span>Returns</a>
<a href="waiting.html" class=""><span class="ni">â³</span>Waiting List</a>
<a href="checklist.html" class=""><span class="ni">â˜‘ï¸</span>Checklists</a>
<a href="targets.html" class=""><span class="ni">ğŸ¯</span>Targets</a>
<a href="audit.html" class=""><span class="ni">ğŸ”</span>Audit Log</a>
<a href="gallery_mgr.html" class=""><span class="ni">ğŸ“¸</span>Gallery Mgr</a>
<div class="sb-sec">Advanced</div><a href="sms.html" class=""><span class="ni">ğŸ“±</span>SMS / Email</a>
<a href="loyalty.html" class=""><span class="ni">ğŸ…</span>Loyalty</a>
<a href="parts_orders.html" class=""><span class="ni">ğŸ›’</span>Parts Orders</a>
<a href="MOT.html" class=""><span class="ni">ğŸ”–</span>MOT Tracker</a>
<a href="service_history.html" class=""><span class="ni">ğŸ“œ</span>Svc History</a>
<a href="staff_rota.html" class=""><span class="ni">ğŸ“†</span>Staff Rota</a>
<a href="hours.html" class=""><span class="ni">â°</span>Opening Hours</a>
<a href="settings.html" class=""><span class="ni">âš™ï¸</span>Settings</a>
</nav>
  <div class="sb-foot">
    <a href="index.html" class="btn-sb-link">ğŸŒ Website</a>
    <button class="btn-sb-out" onclick="if(confirm('Log out?')){sessionStorage.removeItem('dv_admin');location.href='login.html';}">ğŸšª Log Out</button>
  </div>
</div>
<div class="main">
  <div class="topbar"><h1>ğŸ’³ Payments</h1><div class="tr"><button class="btn btn-primary" onclick="openM('mNewPay')">+ Record Payment</button><button class="btn btn-info" onclick="exportPay()">ğŸ“¥ Export</button><button class="btn btn-ghost" onclick="loadPay()">ğŸ”„ Refresh</button></div></div>
  <div class="body">
<div class="stat-grid">
  <div class="card"><div class="card-title">ğŸ’° Total Received</div><div class="card-val" id="pTot">â€”</div></div>
  <div class="card"><div class="card-title">ğŸ“… This Month</div><div class="card-val" id="pMo">â€”</div></div>
  <div class="card"><div class="card-title">ğŸ’³ Card Payments</div><div class="card-val" id="pCard">â€”</div></div>
  <div class="card"><div class="card-title">ğŸ’µ Cash Payments</div><div class="card-val" id="pCash">â€”</div></div>
</div>
<div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
  <div class="srch-w"><input type="text" id="psrch" placeholder="Search payments..." oninput="renderPay()"></div>
  <select id="pmMeth" class="btn btn-ghost" onchange="renderPay()" style="padding:9px 12px;font-size:.82rem">
    <option value="">All Methods</option><option>Cash</option><option>Card</option><option>Bank Transfer</option><option>Cheque</option>
  </select>
  <button class="btn btn-ghost btn-sm" onclick="loadPay()">ğŸ”„</button>
  <button class="btn btn-info btn-sm" onclick="exportPay()">ğŸ“¥ CSV</button>
  <button class="btn btn-warning btn-sm" onclick="window.print()">ğŸ–¨ï¸ Print</button>
</div>
<div class="tbl-wrap"><table><thead><tr>
  <th>Date</th><th>Customer</th><th>Invoice Ref</th><th>Method</th><th>Amount</th><th>Notes</th><th>Actions</th>
</tr></thead><tbody id="payTb"></tbody></table></div>

<div class="modal" id="mNewPay"><div class="mbox">
  <h3>ğŸ’³ Record Payment</h3>
  <div class="g2">
    <div class="fg"><label>Date *</label><input type="date" id="pyDt"></div>
    <div class="fg"><label>Amount (Â£) *</label><input type="number" id="pyAmt" placeholder="0.00" min="0" step="0.01"></div>
  </div>
  <div class="fg ac-w"><label>Customer Name *</label><input type="text" id="pyCN" placeholder="John Smith"></div>
  <div class="g2">
    <div class="fg"><label>Invoice Reference</label><input type="text" id="pyRef" placeholder="INV-0001"></div>
    <div class="fg"><label>Payment Method *</label>
      <select id="pyMeth"><option>Cash</option><option>Card</option><option>Bank Transfer</option><option>Cheque</option><option>Other</option></select>
    </div>
  </div>
  <div class="fg"><label>Notes</label><textarea id="pyNote" placeholder="Any notes..."></textarea></div>
  <div class="mfoot">
    <button class="btn btn-ghost" onclick="closeM('mNewPay')">Cancel</button>
    <button class="btn btn-primary" onclick="savePay()">ğŸ’¾ Save Payment</button>
  </div>
</div></div>
</div>
</div>
<div class="modal" id="mDel"><div class="mbox" style="max-width:360px">
  <h3>ğŸ—‘ï¸ Confirm Delete</h3>
  <p id="mDelMsg" style="color:#555;margin-bottom:4px">This cannot be undone.</p>
  <div class="mfoot">
    <button class="btn btn-ghost" onclick="closeM('mDel')">Cancel</button>
    <button class="btn btn-danger" id="mDelBtn">Yes, Delete</button>
  </div>
</div></div>
<script src="shared.js"></script>
<script>
let payData=[],payEdit=null,payCusts=[];
async function loadPay(){
  payData=await dbGet("payments","&order=payment_date.desc");
  const bks=await dbGet("bookings");
  payCusts=[...new Set(bks.map(b=>b.name).filter(Boolean))];
  const cn=document.getElementById("pyCN");
  if(!cn.dataset.ac){attachAC(cn,payCusts);cn.dataset.ac="1";}
  renderPay();updateStats();
}
function updateStats(){
  const mn=today().slice(0,7);
  const tot=payData.reduce((s,p)=>s+(p.amount||0),0);
  const mo=payData.filter(p=>(p.payment_date||"").startsWith(mn)).reduce((s,p)=>s+(p.amount||0),0);
  const card=payData.filter(p=>p.method==="Card").reduce((s,p)=>s+(p.amount||0),0);
  const cash=payData.filter(p=>p.method==="Cash").reduce((s,p)=>s+(p.amount||0),0);
  document.getElementById("pTot").textContent=fmtGBP(tot);
  document.getElementById("pMo").textContent=fmtGBP(mo);
  document.getElementById("pCard").textContent=fmtGBP(card);
  document.getElementById("pCash").textContent=fmtGBP(cash);
}
function renderPay(){
  const q=document.getElementById("psrch").value.toLowerCase();
  const meth=document.getElementById("pmMeth").value;
  let f=payData.filter(p=>(p.customer_name||"").toLowerCase().includes(q)||(p.invoice_ref||"").toLowerCase().includes(q));
  if(meth)f=f.filter(p=>p.method===meth);
  const tb=document.getElementById("payTb");tb.innerHTML="";
  if(!f.length){tb.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="ei">ğŸ’³</div><p>No payments recorded</p></div></td></tr>`;return;}
  f.forEach(p=>{
    const mc=p.method==="Cash"?"b-ok":p.method==="Card"?"b-in":"b-dk";
    tb.innerHTML+=`<tr>
      <td style="font-size:.82rem">${fmtD(p.payment_date)}</td>
      <td><strong>${p.customer_name||"â€”"}</strong></td>
      <td style="font-family:monospace;font-size:.8rem">${p.invoice_ref||"â€”"}</td>
      <td><span class="badge ${mc}">${p.method||"â€”"}</span></td>
      <td><strong style="color:var(--ac);font-size:1.05rem">${fmtGBP(p.amount)}</strong></td>
      <td style="font-size:.8rem;color:#888">${p.notes||"â€”"}</td>
      <td>
        <button class="btn btn-warning btn-sm" onclick="editPay('${p.id}')">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="delPay('${p.id}')">ğŸ—‘ï¸</button>
      </td></tr>`;
  });
}
function openNewPay(){payEdit=null;document.getElementById("pyDt").value=today();document.getElementById("pyAmt").value="";document.getElementById("pyCN").value="";document.getElementById("pyRef").value="";document.getElementById("pyMeth").value="Cash";document.getElementById("pyNote").value="";openM("mNewPay");}
async function savePay(){
  const dt=document.getElementById("pyDt").value,amt=document.getElementById("pyAmt").value,cn=document.getElementById("pyCN").value.trim();
  if(!dt||!amt||!cn){toast("Fill required fields","er");return;}
  const d={payment_date:dt,amount:parseFloat(amt),customer_name:cn,invoice_ref:document.getElementById("pyRef").value.trim()||null,method:document.getElementById("pyMeth").value,notes:document.getElementById("pyNote").value.trim()||null};
  if(payEdit){await dbUpd("payments",payEdit,d);toast("Updated!");}
  else{await dbIns("payments",d);toast("Payment recorded!");}
  closeM("mNewPay");loadPay();
}
function editPay(id){const p=payData.find(x=>x.id===id);if(!p)return;payEdit=id;document.getElementById("pyDt").value=p.payment_date;document.getElementById("pyAmt").value=p.amount;document.getElementById("pyCN").value=p.customer_name||"";document.getElementById("pyRef").value=p.invoice_ref||"";document.getElementById("pyMeth").value=p.method||"Cash";document.getElementById("pyNote").value=p.notes||"";openM("mNewPay");}
function delPay(id){confirmDel("Delete this payment?",async()=>{await dbDel("payments",id);payData=payData.filter(p=>p.id!==id);renderPay();updateStats();toast("Deleted","in");});}
function exportPay(){const rows=[["Date","Customer","Invoice Ref","Method","Amount","Notes"]];payData.forEach(p=>rows.push([p.payment_date,p.customer_name||"",p.invoice_ref||"",p.method,p.amount,p.notes||""]));const csv=rows.map(r=>r.map(c=>`"${c||""}"`).join(",")).join("
");const a=document.createElement("a");a.href="data:text/csv,"+encodeURIComponent(csv);a.download="payments.csv";a.click();}
document.getElementById("mNewPay").querySelector("h3").onclick=()=>{};
openNewPay;loadPay();
</script>
</body></html>