<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Expenses - DeltaV</title>
<link rel="stylesheet" href="theme.css">
</head><body>
<div class="sidebar">
  <div class="sb-logo">DeltaV <span>Auto</span><small>Admin Panel</small></div>
  <nav>
    <div class="sb-sec">Core</div>
    <a href="dashboard.html" class=""><span class="ni">ğŸ“Š</span>Dashboard</a>
    <a href="admin.html" class=""><span class="ni">ğŸ“…</span>Bookings</a>
    <a href="schedule.html" class=""><span class="ni">ğŸ—“ï¸</span>Schedule</a>
    <a href="customers.html" class=""><span class="ni">ğŸ‘¥</span>Customers</a>
    <a href="contact_inquiries.html" class=""><span class="ni">ğŸ“§</span>Contact Inquiries</a>
    <a href="invoices.html" class=""><span class="ni">ğŸ’°</span>Invoices</a>

    <div class="sb-sec">Stock & Money</div>
    <a href="inventory.html" class=""><span class="ni">ğŸ“¦</span>Inventory</a>
    <a href="payments.html" class=""><span class="ni">ğŸ’³</span>Payments</a>
    <a href="finance.html" class=""><span class="ni">ğŸ“ˆ</span>Finance</a>
    <a href="workers.html" class=""><span class="ni">ğŸ‘·</span>Workers</a>

    <div class="sb-sec">Operations</div>
    <a href="jobs.html" class=""><span class="ni">ğŸ”©</span>Job Cards</a>
    <a href="quotes.html" class=""><span class="ni">ğŸ“‹</span>Quotes</a>
    <a href="suppliers.html" class=""><span class="ni">ğŸ­</span>Suppliers</a>
    <a href="expenses.html" class="active"><span class="ni">ğŸ§¾</span>Expenses</a>
    <a href="reports.html" class=""><span class="ni">ğŸ“‰</span>Reports</a>

    <div class="sb-sec">Comms & Tools</div>
    <a href="messages.html" class=""><span class="ni">ğŸ’¬</span>Messages</a>
    <a href="notes.html" class=""><span class="ni">ğŸ“</span>Notes</a>
    <a href="reminders.html" class=""><span class="ni">ğŸ””</span>Reminders</a>
    <a href="vehicles.html" class=""><span class="ni">ğŸš—</span>Vehicle DB</a>
    <a href="tasks.html" class=""><span class="ni">âœ…</span>Tasks</a>
    <a href="timesheets.html" class=""><span class="ni">â±ï¸</span>Timesheets</a>

    <div class="sb-sec">Extra</div>
    <a href="warranties.html" class=""><span class="ni">ğŸ›¡ï¸</span>Warranties</a>
    <a href="promotions.html" class=""><span class="ni">ğŸ</span>Promotions</a>
    <a href="feedback.html" class=""><span class="ni">â­</span>Feedback</a>
    <a href="returns.html" class=""><span class="ni">â†©ï¸</span>Returns</a>
    <a href="waiting.html" class=""><span class="ni">â³</span>Waiting List</a>
    <a href="checklist.html" class=""><span class="ni">â˜‘ï¸</span>Checklists</a>
    <a href="targets.html" class=""><span class="ni">ğŸ¯</span>Targets</a>
    <a href="audit.html" class=""><span class="ni">ğŸ”</span>Audit Log</a>
    <a href="gallery_mgr.html" class=""><span class="ni">ğŸ“¸</span>Gallery Mgr</a>

    <div class="sb-sec">Advanced</div>
    <a href="sms.html" class=""><span class="ni">ğŸ“±</span>SMS / Email</a>
    <a href="loyalty.html" class=""><span class="ni">ğŸ…</span>Loyalty</a>
    <a href="parts_orders.html" class=""><span class="ni">ğŸ›’</span>Parts Orders</a>
    <a href="MOT.html" class=""><span class="ni">ğŸ”–</span>MOT Tracker</a>
    <a href="service_history.html" class=""><span class="ni">ğŸ“œ</span>Svc History</a>
    <a href="staff_rota.html" class=""><span class="ni">ğŸ“†</span>Staff Rota</a>
    <a href="hours.html" class=""><span class="ni">â°</span>Opening Hours</a>
    <a href="settings.html" class=""><span class="ni">âš™ï¸</span>Settings</a>
  </nav>
  <div class="sb-foot">
    <a href="index.html" class="btn-sb-link">ğŸŒ Website</a>
    <button class="btn-sb-out" onclick="if(confirm('Log out?')){sessionStorage.removeItem('dv_admin');location.href='login.html';}">ğŸšª Log Out</button>
  </div>
</div>
<div class="main">
  <div class="topbar">
    <h1>ğŸ§¾ Expenses</h1>
    <div class="tr">
      <button class="btn btn-primary" onclick="openNew()">+ New</button>
      <button class="btn btn-ghost" onclick="loadData()">ğŸ”„ Refresh</button>
    </div>
  </div>
  <div class="body">
    <div class="tbl-wrap">
      <table><thead><tr><th>Date</th><th>Description</th><th>Amount (Â£)</th><th>Category</th><th>Supplier</th><th>Actions</th></tr></thead><tbody id="tbody"></tbody></table>
    </div>
  </div>
</div>

<div class="modal" id="mForm">
  <div class="mbox">
    <h3 id="formTitle">â• New</h3>
    <div class="fg"><label>Date *</label><input type="date" id="inp0" placeholder="Date"></div><div class="fg"><label>Description</label><input type="text" id="inp1" placeholder="Description"></div><div class="fg"><label>Amount (Â£)</label><input type="number" id="inp2" placeholder="Amount (Â£)"></div><div class="fg"><label>Category</label><input type="text" id="inp3" placeholder="Category"></div><div class="fg"><label>Supplier</label><input type="text" id="inp4" placeholder="Supplier"></div>
    <div class="mfoot">
      <button class="btn btn-ghost" onclick="closeM('mForm')">Cancel</button>
      <button class="btn btn-primary" onclick="saveData()">ğŸ’¾ Save</button>
    </div>
  </div>
</div>

<div class="modal" id="mDel">
  <div class="mbox" style="max-width:400px">
    <h3>ğŸ—‘ï¸ Confirm Delete</h3>
    <p id="mDelMsg" style="color:#64748b;line-height:1.8">Are you sure? This cannot be undone.</p>
    <div class="mfoot">
      <button class="btn btn-ghost" onclick="closeM('mDel')">Cancel</button>
      <button class="btn btn-danger" id="mDelBtn">Yes, Delete</button>
    </div>
  </div>
</div>

<div class="modal" id="mError">
  <div class="mbox" style="max-width:420px">
    <h3>âŒ Error</h3>
    <p id="errorMsg" style="color:#64748b;line-height:1.8"></p>
    <div class="mfoot">
      <button class="btn btn-primary" onclick="closeM('mError')">OK</button>
    </div>
  </div>
</div>

<script src="shared.js"></script>
<script>
let data=[],editId=null;
async function loadData(){
  try{
    data=await dbGet("expenses","&order=created_at.desc");
    renderData();
  }catch(e){showError("Failed to load. Make sure 'expenses' table exists in Supabase!");}
}
function renderData(){
  const tb=document.getElementById("tbody");
  if(!data.length){
    tb.innerHTML='<tr><td colspan="99"><div class="empty"><div class="ei">ğŸ§¾</div><h3>No data yet</h3><p>Click "+ New" to add your first entry</p></div></td></tr>';
    return;
  }
  tb.innerHTML=data.map(r=>`<tr><td>${r.expense_date || 'â€”'}</td><td>${r.description || 'â€”'}</td><td>${r.amount || 'â€”'}</td><td>${r.category || 'â€”'}</td><td>${r.supplier || 'â€”'}</td><td><button class="btn btn-warning btn-sm" onclick="editRow('${r.id}')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="confirmDel('Delete this?',()=>deleteRow('${r.id}'))">ğŸ—‘ï¸</button></td></tr>`).join('');
}
function openNew(){editId=null;document.getElementById("formTitle").textContent="â• New";document.getElementById("inp0").value = ""; document.getElementById("inp1").value = ""; document.getElementById("inp2").value = ""; document.getElementById("inp3").value = ""; document.getElementById("inp4").value = "";openM("mForm");}
function editRow(id){const r=data.find(x=>x.id===id);if(!r)return;editId=id;document.getElementById("formTitle").textContent="âœï¸ Edit";document.getElementById("inp0").value = r.expense_date || ""; document.getElementById("inp1").value = r.description || ""; document.getElementById("inp2").value = r.amount || ""; document.getElementById("inp3").value = r.category || ""; document.getElementById("inp4").value = r.supplier || "";openM("mForm");}
async function saveData(){
  const val=document.getElementById("inp0").value.trim();
  if(!val){showError("Date is required!");return;}
  const d={expense_date: document.getElementById("inp0").value.trim() || null, description: document.getElementById("inp1").value.trim() || null, amount: document.getElementById("inp2").value.trim() || null, category: document.getElementById("inp3").value.trim() || null, supplier: document.getElementById("inp4").value.trim() || null};
  try{
    if(editId){
      await dbUpd("expenses",editId,d);
      showToast("Updated successfully!","success");
    }else{
      await dbIns("expenses",d);
      showToast("Added successfully!","success");
    }
    closeM("mForm");
    loadData();
  }catch(e){showError("Failed to save: "+e.message);}
}
async function deleteRow(id){
  try{
    await dbDel("expenses",id);
    data=data.filter(x=>x.id!==id);
    renderData();
    showToast("Deleted successfully!","success");
  }catch(e){showError("Failed to delete: "+e.message);}
}
async function initExpenseAC(){const categories=[...new Set(data.map(r=>r.category).filter(Boolean))];const suppliers=[...new Set(data.map(r=>r.supplier).filter(Boolean))];attachAC(document.getElementById("inp3"),categories);attachAC(document.getElementById("inp4"),suppliers);}
loadData();initExpenseAC();
</script>
</body></html>